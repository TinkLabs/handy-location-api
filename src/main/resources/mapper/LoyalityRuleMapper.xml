<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tinklabs.mapper.LoyalityRuleMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.tinklabs.entity.LoyalityRule">
        <id column="id" property="id"/>
        <result column="effective_begin_time" property="effectiveBeginTime"/>
        <result column="effective_end_time" property="effectiveEndTime"/>
        <result column="percentage" property="percentage"/>
        <result column="priority" property="priority"/>
        <result column="is_active" property="isActive"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,effective_begin_time,effective_end_time,percentage,priority,is_active,create_by,create_time,update_by,update_time
    </sql>
    <select id="queryPercentageByRule" resultType="float">
        SELECT
        `percentage` AS percentage
        FROM loyality_rule r
        WHERE r.is_active = 1
        <if test="order.orderDate != null">
            AND DATE_FORMAT(#{order.orderDate},"%Y-%m-%d") BETWEEN DATE_FORMAT(effective_begin_time,"%Y-%m-%d") and
            DATE_FORMAT(Effective_end_time,"%Y-%m-%d")
        </if>

        ORDER BY r.priority DESC LIMIT 1
    </select>

</mapper>